<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MagicBank Academy Â· Aula</title>

  <style>
    * {
      box-sizing: border-box;
      font-family: Arial, Helvetica, sans-serif;
    }

    body {
      margin: 0;
      background: #f4f6f8;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #0b2a4a;
      color: #d4af37;
      padding: 12px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      flex-shrink: 0;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background: white;
    }

    .msg {
      margin-bottom: 10px;
    }

    .user {
      font-weight: bold;
      color: #0b2a4a;
    }

    .bot {
      font-weight: bold;
      color: #444;
    }

    footer {
      display: flex;
      gap: 6px;
      padding: 10px;
      border-top: 1px solid #ddd;
      background: #fafafa;
      flex-shrink: 0;
    }

    input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
    }

    button {
      padding: 10px 14px;
      font-size: 16px;
      cursor: pointer;
      border: none;
    }

    #sendBtn {
      background: #d4af37;
      color: black;
    }

    #micBtn {
      background: #0b2a4a;
      color: white;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 20px;
      transition: background 0.3s, transform 0.2s;
    }

    #micBtn.listening {
      background: #c62828;
      transform: scale(1.1);
    }
  </style>
</head>

<body>

  <header>
    MagicBank Academy Â· Aula
  </header>

  <div id="chat"></div>

  <footer>
    <input id="text" placeholder="Escribe al tutorâ€¦" />
    <button id="micBtn" onclick="startVoice()">ðŸŽ¤</button>
    <button id="sendBtn" onclick="send()">Enviar</button>
  </footer>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("text");
    const micBtn = document.getElementById("micBtn");

    function addMessage(who, text) {
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `<span class="${who}">${who === 'user' ? 'TÃº' : 'Tutor'}:</span> ${text}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function send(textFromVoice) {
      const text = textFromVoice || input.value.trim();
      if (!text) return;

      addMessage("user", text);
      input.value = "";

      try {
        const res = await fetch("https://magic-bank-backend-production-713e.up.railway.app/api/magicbank/aula/texto", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            texto: text,
            course_id: "magicbank-academy"
          })
        });

        const data = await res.json();
        const reply = data?.respuesta || "Sin respuesta";
        addMessage("bot", reply);
        speak(reply);

      } catch (e) {
        addMessage("bot", "Error de conexiÃ³n con el tutor");
      }
    }

    function startVoice() {
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!SpeechRecognition) {
        alert("MicrÃ³fono no soportado");
        return;
      }

      const rec = new SpeechRecognition();
      rec.lang = "es-ES";
      rec.interimResults = false;

      micBtn.classList.add("listening");
      rec.start();

      rec.onresult = e => {
        const text = e.results[0][0].transcript;
        send(text);
      };

      rec.onend = () => {
        micBtn.classList.remove("listening");
      };

      rec.onerror = () => {
        micBtn.classList.remove("listening");
        alert("Error con el micrÃ³fono");
      };
    }

    function speak(text) {
      if (!window.speechSynthesis) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "es-ES";
      speechSynthesis.speak(u);
    }
  </script>

</body>
</html>
